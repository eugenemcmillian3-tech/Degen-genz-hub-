'use client';

import { useState, useEffect } from 'react';
import { sdk } from '@farcaster/miniapp-sdk';

interface FarcasterUser {
  fid: number;
  username?: string;
  displayName?: string;
  pfpUrl?: string;
}

export function useFarcasterAuth(): {
  user: FarcasterUser | null;
  loading: boolean;
  error: string | null;
  userId: string | null;
} {
  const [user, setUser] = useState<FarcasterUser | null>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const authenticate = async (): Promise<void> => {
      try {
        // Set a timeout to prevent infinite loading
        const timeoutId = setTimeout(() => {
          console.warn('Authentication timeout - using demo mode');
          setUser({
            fid: 1378286,
            username: 'demo-user',
            displayName: 'Demo User',
          });
          setUserId('demo-user-id');
          setLoading(false);
        }, 3000);

        const res = await sdk.quickAuth.fetch('/api/auth/me');
        clearTimeout(timeoutId);

        if (res.ok) {
          const userData = await res.json();
          setUser(userData);

          // Try to create/update user in Supabase, but don't block if it fails
          try {
            const userRes = await fetch('/api/user/from-fid', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                fid: userData.fid,
                username: userData.username,
              }),
            });

            if (userRes.ok) {
              const { user: dbUser } = await userRes.json();
              setUserId(dbUser.id);
            } else {
              // Use FID as userId if Supabase fails
              console.warn('Supabase user creation failed, using FID as userId');
              setUserId(`fid-${userData.fid}`);
            }
          } catch (dbError) {
            console.warn('Database connection failed:', dbError);
            setUserId(`fid-${userData.fid}`);
          }
          
          setLoading(false);
        } else {
          clearTimeout(timeoutId);
          setError('Authentication failed');
          setLoading(false);
        }
      } catch (err) {
        console.error('Auth error:', err);
        // Fallback to demo mode for testing
        setUser({
          fid: 1378286,
          username: 'demo-user',
          displayName: 'Demo User (Fallback)',
        });
        setUserId('demo-user-id');
        setError(err instanceof Error ? err.message : 'Authentication error');
        setLoading(false);
      }
    };

    authenticate();
  }, []);

  return { user, loading, error, userId };
}
